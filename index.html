<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xtream Player Pro - ArtPlayer Ultimate V8</title>
    
    <!-- مكتبات التشغيل الثلاثة (السر لتشغيل كل شيء) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@latest/dist/mpegts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    
    <!-- الخطوط والأيقونات -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- التصميم العام (Dark Glass Theme) --- */
        :root {
            --bg-gradient: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
            --primary: #00ff88; /* أخضر نيون */
            --secondary: #16213e;
            --text: #ffffff;
            --glass: rgba(255, 255, 255, 0.05);
            --border: 1px solid rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background: var(--bg-gradient); color: var(--text); height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }

        /* سكرول بار */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* الشاشة الرئيسية */
        .landing-container { display: flex; width: 95vw; max-width: 1200px; height: 90vh; background: rgba(0,0,0,0.8); border: var(--border); backdrop-filter: blur(10px); border-radius: 20px; overflow: hidden; box-shadow: 0 0 50px rgba(0, 255, 136, 0.1); }
        
        .left-panel { width: 320px; background: rgba(0,0,0,0.6); border-left: var(--border); display: flex; flex-direction: column; padding: 20px; }
        .panel-title { font-size: 14px; margin-bottom: 20px; color: #fff; font-weight: bold; border-bottom: 2px solid var(--primary); padding-bottom: 10px; display: inline-block; }
        
        .accounts-grid { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .user-card { background: var(--glass); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: 0.2s; position: relative; border: 1px solid transparent; }
        .user-card:hover { background: rgba(255,255,255,0.1); border-color: var(--primary); }
        .user-avatar { width: 40px; height: 40px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; font-weight: bold; font-size: 18px; }
        .user-details h3 { margin: 0; font-size: 14px; color: #fff; }
        .user-details p { margin: 3px 0 0; font-size: 11px; color: #aaa; }
        .delete-user { position: absolute; left: 10px; color: #ff4757; opacity: 0; transition: 0.2s; }
        .user-card:hover .delete-user { opacity: 1; }

        .add-user-btn { margin-top: 20px; padding: 12px; background: transparent; border: 1px dashed #555; color: #aaa; text-align: center; cursor: pointer; transition: 0.2s; border-radius: 8px; font-size: 13px; }
        .add-user-btn:hover { border-color: var(--primary); color: var(--primary); }

        .right-panel { flex: 1; padding: 40px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; }
        .welcome-msg { text-align: center; }
        .welcome-msg i { font-size: 70px; color: var(--primary); margin-bottom: 20px; filter: drop-shadow(0 0 10px var(--primary)); }
        
        .auth-forms { width: 100%; max-width: 400px; display: none; animation: fadeIn 0.5s; }
        .auth-forms.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .tabs { display: flex; gap: 10px; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 10px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-size: 12px; color: #aaa; border-radius: 8px; transition: 0.3s; }
        .tab.active { background: var(--primary); color: #000; font-weight: bold; }

        .main-inp { width: 100%; padding: 14px; background: rgba(0,0,0,0.5); border: var(--border); color: #fff; margin-bottom: 12px; border-radius: 8px; font-family: inherit; font-size: 13px; transition: 0.3s; }
        .main-inp:focus { border-color: var(--primary); }
        .action-btn { width: 100%; padding: 14px; background: var(--primary); border: none; color: #000; font-weight: bold; cursor: pointer; border-radius: 8px; margin-top: 10px; transition: 0.3s; }
        .action-btn:hover { transform: scale(1.02); box-shadow: 0 0 15px var(--primary); }

        /* --- واجهة المشغل --- */
        .player-layout { display: none; width: 100vw; height: 100vh; background: #000; flex-direction: row; }
        
        .ch-sidebar { width: 320px; background: #0f0f1a; border-left: var(--border); display: flex; flex-direction: column; z-index: 20; }
        .sidebar-head { padding: 15px; background: #000; border-bottom: var(--border); display: flex; justify-content: space-between; align-items: center; }
        .srch-inp { width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: var(--border); color: white; margin: 10px; width: calc(100% - 20px); border-radius: 6px; text-align: center; }
        
        .ch-list { flex: 1; overflow-y: auto; }
        .ch-row { display: flex; align-items: center; gap: 10px; padding: 12px 15px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.02); transition: 0.2s; }
        .ch-row:hover { background: rgba(255,255,255,0.05); }
        .ch-row.active { background: rgba(0,255,136,0.1); border-right: 3px solid var(--primary); }
        .ch-row span { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: #ddd; }
        .ch-row img { width: 30px; height: 30px; object-fit: contain; }

        /* ArtPlayer Container */
        .video-container { flex: 1; background: #000; position: relative; width: 100%; height: 100%; }
        .artplayer-app { width: 100%; height: 100%; }

        /* تنبيهات */
        .http-warning {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 71, 87, 0.9); color: white; padding: 10px; border-radius: 5px;
            font-size: 12px; display: none; z-index: 100; text-align: center;
        }

        @media (max-width: 768px) {
            .landing-container { flex-direction: column-reverse; width: 100%; height: 100%; border-radius: 0; border: none; }
            .left-panel { width: 100%; height: 45%; }
            .right-panel { height: 55%; padding: 20px; }
            .player-layout { flex-direction: column-reverse; }
            .ch-sidebar { width: 100%; height: 50%; }
            .video-container { width: 100%; height: 50%; }
        }
        
        .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); color: #000; padding: 10px 25px; border-radius: 50px; font-size: 13px; font-weight: bold; display: none; z-index: 10000; }
    </style>
</head>
<body>

    <div id="toast" class="toast"></div>

    <!-- 1. الشاشة الرئيسية -->
    <div class="landing-container" id="landingScreen">
        <div class="left-panel">
            <div class="panel-title">قوائم التشغيل</div>
            <div class="accounts-grid" id="accountsGrid"></div>
            <div class="add-user-btn" onclick="showAddForm()">+ إضافة حساب جديد</div>
        </div>

        <div class="right-panel">
            <div id="welcomeScreen" class="welcome-msg">
                <i class="fas fa-meteor"></i>
                <h2>Xtream ArtPlayer V8</h2>
                <p style="color:#aaa; margin-top:10px;">المشغل الوحيد الذي يدعم MPEGTS & HLS</p>
                <div style="margin-top:20px; font-size:11px; color:#ff4757; background:rgba(255,0,0,0.1); padding:10px; border-radius:5px;">
                    ⚠️ تنبيه: الروابط http:// لن تعمل إذا كان الموقع https://<br>
                    يرجى تحميل هذا الملف وتشغيله محلياً.
                </div>
            </div>

            <div id="addForms" class="auth-forms">
                <div class="tabs">
                    <div class="tab active" onclick="setTab('xtream')">Xtream</div>
                    <div class="tab" onclick="setTab('direct')">رابط مباشر</div>
                    <div class="tab" onclick="setTab('m3u')">ملف M3U</div>
                </div>

                <!-- Xtream -->
                <div id="xtreamInput">
                    <input type="text" id="xHost" class="main-inp" placeholder="Host (http://domain.com:8080)">
                    <input type="text" id="xUser" class="main-inp" placeholder="Username">
                    <input type="password" id="xPass" class="main-inp" placeholder="Password">
                    <button class="action-btn" onclick="connectXtream()">اتصال</button>
                </div>

                <!-- Direct Link -->
                <div id="directInput" style="display: none;">
                    <input type="text" id="dLink" class="main-inp" placeholder="ألصق رابط القناة (يدعم الروابط الخام)">
                    <p style="font-size:10px; color:#aaa; text-align:center;">* سيحاول المشغل إصلاح الرابط تلقائياً</p>
                    <button class="action-btn" onclick="playDirect()">تشغيل</button>
                </div>

                <!-- M3U -->
                <div id="m3uInput" style="display: none;">
                    <div style="border: 2px dashed #444; padding: 30px; text-align: center; border-radius: 10px; cursor: pointer;" onclick="document.getElementById('m3uFile').click()">
                        <i class="fas fa-file-alt" style="font-size: 30px; color: var(--primary); margin-bottom: 10px;"></i>
                        <p style="margin:0; font-size:12px; color:#888;" id="fileName">اختر ملف M3U</p>
                        <input type="file" id="m3uFile" accept=".m3u,.m3u8" style="display: none;" onchange="startM3U()">
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px; cursor: pointer; color: #666; font-size: 12px;" onclick="hideAddForm()">إلغاء</div>
            </div>
        </div>
    </div>

    <!-- 2. المشغل -->
    <div class="player-layout" id="playerScreen">
        <div class="ch-sidebar">
            <div class="sidebar-head">
                <div style="color:var(--primary); font-weight:bold; font-size:14px; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-user-astronaut"></i> <span id="currentUser">User</span>
                </div>
                <i class="fas fa-sign-out-alt" style="color:#666; cursor:pointer;" onclick="location.reload()" title="Logout"></i>
            </div>
            <input type="text" id="searchInp" class="srch-inp" placeholder="بحث في القنوات..." onkeyup="filterChannels()">
            <div class="ch-list" id="chList"></div>
        </div>

        <div class="video-container">
            <div id="artplayer" class="artplayer-app"></div>
            <div id="httpWarning" class="http-warning">
                أنت تحاول تشغيل رابط HTTP غير آمن في موقع HTTPS.<br>
                لن يعمل الفيديو إلا إذا فتحت هذا الملف من جهازك مباشرة.
            </div>
        </div>
    </div>

    <script>
        let art;
        let accounts = JSON.parse(localStorage.getItem('xtream_users_art') || '[]');
        let allChannels = [];
        let currentAuth = {}; 

        document.addEventListener('DOMContentLoaded', () => {
            loadAccounts();
        });

        // --- تهيئة ArtPlayer (الجوهرة) ---
        function initArtPlayer(url) {
            if (art) art.destroy();

            // فحص نوع الرابط
            let type = 'm3u8';
            if (url.endsWith('.ts') || url.match(/\/\d+$/)) { // إذا كان ينتهي برقم أو ts
                type = 'mpegts'; // استخدم محرك mpegts
            }

            console.log("Playing URL:", url, "Type:", type);

            // التحقق من مشكلة Mixed Content
            if(location.protocol === 'https:' && url.startsWith('http:')) {
                document.getElementById('httpWarning').style.display = 'block';
            } else {
                document.getElementById('httpWarning').style.display = 'none';
            }

            art = new Artplayer({
                container: '#artplayer',
                url: url,
                type: type, // تحديد النوع (تلقائي أو mpegts)
                autoplay: true,
                isLive: true,
                fullscreen: true,
                pip: true,
                setting: true,
                customType: {
                    m3u8: function (video, url) {
                        if (Hls.isSupported()) {
                            const hls = new Hls();
                            hls.loadSource(url);
                            hls.attachMedia(video);
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        }
                    },
                    mpegts: function (video, url) {
                        if (mpegts.isSupported()) {
                            const player = mpegts.createPlayer({
                                type: 'mpegts',
                                url: url,
                                isLive: true,
                            });
                            player.attachMediaElement(video);
                            player.load();
                            player.play();
                        } else {
                            toast('المتصفح لا يدعم MPEGTS');
                        }
                    }
                }
            });

            // موبايل تدوير
            art.on('play', () => {
                if(window.innerWidth < 768) {
                    art.fullscreen = true;
                }
            });
        }

        // --- أدوات ---
        function toast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
        function showAddForm() { document.getElementById('welcomeScreen').style.display='none'; document.getElementById('addForms').classList.add('active'); }
        function hideAddForm() { document.getElementById('addForms').classList.remove('active'); document.getElementById('welcomeScreen').style.display='block'; }

        function setTab(mode) {
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
            document.querySelectorAll('#addForms > div[id$="Input"]').forEach(d=>d.style.display='none');
            if(mode==='xtream') { document.querySelectorAll('.tab')[0].classList.add('active'); document.getElementById('xtreamInput').style.display='block'; }
            else if(mode==='direct') { document.querySelectorAll('.tab')[1].classList.add('active'); document.getElementById('directInput').style.display='block'; }
            else { document.querySelectorAll('.tab')[2].classList.add('active'); document.getElementById('m3uInput').style.display='block'; }
        }

        // --- الحسابات ---
        function loadAccounts() {
            const g = document.getElementById('accountsGrid'); g.innerHTML='';
            if(accounts.length===0) return g.innerHTML='<p style="text-align:center; color:#555; font-size:12px; margin-top:20px;">لا توجد حسابات</p>';
            
            accounts.forEach((acc, i) => {
                const d = document.createElement('div'); d.className='user-card';
                d.innerHTML = `
                    <div class="user-avatar">${acc.user.charAt(0).toUpperCase()}</div>
                    <div class="user-details"><h3>${acc.user}</h3><p>${acc.type}</p></div>
                    <i class="fas fa-trash delete-user" onclick="deleteAcc(${i}, event)"></i>
                `;
                d.onclick = () => { if(acc.type==='direct') playDirect(acc.url); else loginXtream(acc); };
                g.appendChild(d);
            });
        }
        function deleteAcc(i,e) { e.stopPropagation(); accounts.splice(i,1); localStorage.setItem('xtream_users_art', JSON.stringify(accounts)); loadAccounts(); }

        // --- 1. تشغيل مباشر ---
        function playDirect(savedUrl) {
            let url = savedUrl || document.getElementById('dLink').value.trim();
            if(!url) return toast('أدخل الرابط');
            
            if(!savedUrl) {
                accounts.push({ type:'direct', user:'Stream', url: url });
                localStorage.setItem('xtream_users_art', JSON.stringify(accounts));
                loadAccounts();
            }

            // محاولة ذكية: إذا الرابط xtream عادي (رقم في النهاية) نجرب إضافة m3u8
            // أما إذا كان المستخدم يريده خام (مثل رابطك) سيحاول المشغل تشغيله عبر mpegts
            let finalUrl = url;
            // الملاحظة: في ArtPlayer، نمرر الرابط كما هو، ونحدد النوع في الدالة initArtPlayer

            launchUI('Direct', [{ name: 'Live Stream', logo: '', url: finalUrl }], {type:'direct'});
            setTimeout(() => initArtPlayer(finalUrl), 500);
        }

        // --- 2. Xtream ---
        async function connectXtream() {
            let host = document.getElementById('xHost').value.trim();
            let user = document.getElementById('xUser').value.trim();
            let pass = document.getElementById('xPass').value.trim();
            if(!host || !user || !pass) return toast('أدخل البيانات');
            if(!host.startsWith('http')) host = 'http://'+host;

            const apiUrl = `${host}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
            const proxy = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;

            try {
                let res;
                try { res = await fetch(apiUrl); } catch { res = await fetch(proxy); }
                const data = await res.json();
                if(!Array.isArray(data)) throw new Error();

                if(!accounts.some(a=>a.host===host && a.user===user)) {
                    accounts.push({ type:'xtream', host, user, pass });
                    localStorage.setItem('xtream_users_art', JSON.stringify(accounts));
                    loadAccounts();
                }
                launchUI(user, data, { type:'xtream', host, user, pass });
            } catch { toast('فشل الاتصال'); }
        }

        async function loginXtream(acc) {
            toast('جاري الاتصال...');
            const apiUrl = `${acc.host}/player_api.php?username=${acc.user}&password=${acc.pass}&action=get_live_streams`;
            const proxy = `https://corsproxy.io/?${encodeURIComponent(apiUrl)}`;
            try {
                let res;
                try { res = await fetch(apiUrl); } catch { res = await fetch(proxy); }
                const data = await res.json();
                launchUI(acc.user, data, acc);
            } catch { toast('خطأ في السيرفر'); }
        }

        // --- 3. M3U ---
        function startM3U() {
            const f = document.getElementById('m3uFile').files[0];
            if(!f) return;
            document.getElementById('fileName').innerText = f.name;
            const r = new FileReader();
            r.onload = (e) => {
                const lines = e.target.result.split('\n');
                const chs = [];
                let curr = { name:'No Name', logo:'', url:'' };
                lines.forEach(l => {
                    l = l.trim();
                    if(l.startsWith('#EXTINF:')) {
                        curr.name = l.split(',')[1] || 'No Name';
                        const logo = l.match(/tvg-logo="([^"]*)"/);
                        if(logo) curr.logo = logo[1];
                    } else if(l.startsWith('http')) {
                        curr.url = l;
                        chs.push({...curr});
                        curr = { name:'No Name', logo:'', url:'' };
                    }
                });
                launchUI('M3U File', chs, { type:'m3u' });
            };
            r.readAsText(f);
        }

        // --- واجهة المستخدم ---
        function launchUI(username, channels, auth) {
            currentAuth = auth;
            allChannels = channels;
            document.getElementById('landingScreen').style.display = 'none';
            document.getElementById('playerScreen').style.display = 'flex';
            document.getElementById('currentUser').innerText = username;
            
            renderChannels(channels);
        }

        function renderChannels(list) {
            const c = document.getElementById('chList'); c.innerHTML = '';
            list.slice(0, 1000).forEach(ch => {
                const div = document.createElement('div'); div.className = 'ch-row';
                let img = ch.logo || (currentAuth.type === 'xtream' ? ch.stream_icon : null);
                
                div.innerHTML = `
                    <div style="width:30px; text-align:center;">
                         ${img ? `<img src="${img}" style="width:100%; height:30px; object-fit:contain;" onerror="this.style.display='none'">` : '<i class="fas fa-tv" style="color:#555"></i>'}
                    </div>
                    <span>${ch.name}</span>
                `;
                div.onclick = () => playStream(ch, div);
                c.appendChild(div);
            });
        }

        function playStream(ch, el) {
            if(el) {
                document.querySelectorAll('.ch-row').forEach(r => r.classList.remove('active'));
                el.classList.add('active');
            }

            let url = ch.url;
            if(currentAuth.type === 'xtream') {
                // في ArtPlayer، نجرب إرسال الرابط الخام إذا كان السيرفر يدعمه، أو نضيف m3u8
                // هنا سنقوم بإضافة m3u8 كخيار آمن، لكن يمكنك إزالتها إذا أردت استخدام mpegts
                const rawUrl = `${currentAuth.host}/live/${currentAuth.user}/${currentAuth.pass}/${ch.stream_id}`;
                url = rawUrl + ".m3u8"; // نفضل HLS، إذا فشل المستخدم يمكنه استخدام التبويب "Direct" للرابط الخام
            }

            initArtPlayer(url);
        }

        function filterChannels() {
            const v = document.getElementById('searchInp').value.toLowerCase();
            renderChannels(allChannels.filter(c => c.name.toLowerCase().includes(v)));
        }
    </script>
</body>
</html>
