<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- منع إرسال Referrer للخداع السيرفرات -->
    <meta name="referrer" content="no-referrer">
    <title>Universal IPTV Player - Netlify Edition</title>
    
    <!-- مكتبات التشغيل -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    
    <!-- الخطوط -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #0f0f13;
            --sidebar: #18181f;
            --accent: #ff0055; /* لون وردي نيون */
            --text: #eee;
            --border: 1px solid #2a2a35;
        }

        body { margin: 0; font-family: 'Cairo', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }
        * { box-sizing: border-box; outline: none; }

        /* القائمة الجانبية */
        .sidebar {
            width: 300px; background: var(--sidebar); border-left: var(--border);
            display: flex; flex-direction: column; z-index: 50; transition: 0.3s;
        }
        
        .header {
            padding: 15px; background: #111; border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .header h3 { margin: 0; font-size: 16px; color: var(--accent); }

        /* منطقة التحكم */
        .controls { padding: 10px; border-bottom: var(--border); background: #14141a; }
        
        .tab-group { display: flex; gap: 5px; margin-bottom: 10px; }
        .tab { 
            flex: 1; padding: 8px; background: #222; border: none; color: #888; 
            cursor: pointer; border-radius: 4px; font-size: 11px; font-weight: bold;
        }
        .tab.active { background: var(--accent); color: #fff; }

        .input-box { width: 100%; padding: 10px; background: #000; border: 1px solid #333; color: #fff; border-radius: 4px; margin-bottom: 5px; font-family: inherit; font-size: 12px; }
        .btn { width: 100%; padding: 10px; background: #2a2a35; border: none; color: #fff; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:hover { background: var(--accent); }

        /* قائمة القنوات */
        .channel-list { flex: 1; overflow-y: auto; padding: 5px; }
        .ch-item {
            display: flex; align-items: center; gap: 10px; padding: 10px; 
            border-bottom: 1px solid #222; cursor: pointer; border-radius: 4px;
        }
        .ch-item:hover { background: #222; }
        .ch-item.active { background: rgba(255, 0, 85, 0.1); border-right: 3px solid var(--accent); }
        .ch-img { width: 30px; height: 30px; background: #000; border-radius: 4px; object-fit: contain; }
        .ch-name { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* الفيديو */
        .video-area { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; position: relative; }
        .plyr { width: 100%; height: 100%; }

        /* رسالة التنبيه */
        .proxy-badge {
            position: absolute; top: 10px; right: 10px; background: rgba(255, 166, 0, 0.9);
            color: #000; padding: 5px 10px; border-radius: 4px; font-size: 11px; font-weight: bold;
            display: none; z-index: 100;
        }

        /* موبايل */
        @media (max-width: 768px) {
            body { flex-direction: column-reverse; }
            .sidebar { width: 100%; height: 50%; }
            .video-area { height: 50%; }
        }
        
        .loading { display: none; margin-left: 5px; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="header">
            <h3><i class="fas fa-satellite-dish"></i> XTREAM NETLIFY</h3>
            <span style="font-size: 10px; color: #666;" id="count">0 CH</span>
        </div>

        <div class="controls">
            <div class="tab-group">
                <button class="tab active" onclick="switchMode('url')">Playlist URL</button>
                <button class="tab" onclick="switchMode('xtream')">Xtream</button>
                <button class="tab" onclick="switchMode('file')">File</button>
            </div>

            <!-- 1. رابط القائمة (M3U URL) -->
            <div id="mode-url">
                <input type="text" id="m3u-url" class="input-box" placeholder="http://server.com/get.php?username=...">
                <button class="btn" onclick="fetchPlaylist()">LOAD LIST <i class="fas fa-spinner fa-spin loading" id="loader1"></i></button>
            </div>

            <!-- 2. Xtream -->
            <div id="mode-xtream" style="display:none;">
                <input type="text" id="x-host" class="input-box" placeholder="Host (http://url:port)">
                <div style="display:flex; gap:5px;">
                    <input type="text" id="x-user" class="input-box" placeholder="User">
                    <input type="text" id="x-pass" class="input-box" placeholder="Pass">
                </div>
                <button class="btn" onclick="loginXtream()">LOGIN <i class="fas fa-spinner fa-spin loading" id="loader2"></i></button>
            </div>

            <!-- 3. ملف -->
            <div id="mode-file" style="display:none;">
                <button class="btn" style="background:#222; border:1px dashed #444;" onclick="document.getElementById('file-up').click()">Select M3U File</button>
                <input type="file" id="file-up" style="display:none" onchange="parseFile()">
            </div>

            <input type="text" id="search" class="input-box" style="margin-top:10px; text-align:center;" placeholder="Search Channel..." onkeyup="doSearch()">
        </div>

        <div class="channel-list" id="ch-list">
            <div style="text-align:center; padding:20px; color:#444; font-size:12px;">Waiting for input...</div>
        </div>
    </div>

    <div class="video-area">
        <div id="proxy-badge" class="proxy-badge"><i class="fas fa-shield-alt"></i> Proxy Active</div>
        <video id="player" playsinline controls>
            <source src="" type="application/x-mpegURL">
        </video>
    </div>

    <script>
        // المتغيرات
        let player, hls;
        let allChannels = [];
        
        // عند التحميل
        document.addEventListener('DOMContentLoaded', () => {
            player = new Plyr('#player', {
                controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'pip', 'fullscreen'],
                autoplay: true
            });

            // استعادة آخر رابط
            const last = localStorage.getItem('last_playlist');
            if(last) document.getElementById('m3u-url').value = last;
        });

        function switchMode(mode) {
            document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            ['url', 'xtream', 'file'].forEach(m => document.getElementById(`mode-${m}`).style.display = 'none');
            document.getElementById(`mode-${mode}`).style.display = 'block';
        }

        // --- 1. معالج روابط M3U (get.php) ---
        async function fetchPlaylist() {
            const url = document.getElementById('m3u-url').value.trim();
            if(!url) return alert('Enter URL');
            
            document.getElementById('loader1').style.display = 'inline-block';
            
            // نستخدم Proxy لجلب محتوى ملف M3U النصي لتجاوز CORS
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
            
            try {
                const res = await fetch(proxyUrl);
                if(!res.ok) throw new Error('Failed');
                const text = await res.text();
                
                parseM3U(text);
                localStorage.setItem('last_playlist', url); // حفظ للزيارة القادمة

            } catch(e) {
                alert('Failed to load playlist. Check URL or CORS.');
            } finally {
                document.getElementById('loader1').style.display = 'none';
            }
        }

        // --- 2. Xtream Login ---
        async function loginXtream() {
            let host = document.getElementById('x-host').value.trim();
            let user = document.getElementById('x-user').value.trim();
            let pass = document.getElementById('x-pass').value.trim();
            
            if(!host.startsWith('http')) host = 'http://' + host;
            
            document.getElementById('loader2').style.display = 'inline-block';
            
            // جلب القنوات عبر API
            const api = `${host}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
            const proxy = `https://api.allorigins.win/raw?url=${encodeURIComponent(api)}`;
            
            try {
                const res = await fetch(proxy);
                const data = await res.json();
                
                // تحويل لنمط القنوات الموحد
                allChannels = data.map(ch => ({
                    name: ch.name,
                    logo: ch.stream_icon,
                    // رابط Xtream دائماً نحوله لـ m3u8 ليقبله HLS.js
                    url: `${host}/live/${user}/${pass}/${ch.stream_id}.m3u8`
                }));
                
                renderList(allChannels);

            } catch(e) {
                alert('Login Failed');
            } finally {
                document.getElementById('loader2').style.display = 'none';
            }
        }

        // --- 3. ملف محلي ---
        function parseFile() {
            const file = document.getElementById('file-up').files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => parseM3U(e.target.result);
            reader.readAsText(file);
        }

        // --- المترجم (Parser) ---
        function parseM3U(data) {
            const lines = data.split('\n');
            allChannels = [];
            let ch = { name: 'Unknown', logo: '', url: '' };

            for(let line of lines) {
                line = line.trim();
                if(!line) continue;
                
                if(line.startsWith('#EXTINF:')) {
                    ch.name = line.split(',')[1] || 'Unknown';
                    const logo = line.match(/tvg-logo="([^"]*)"/);
                    if(logo) ch.logo = logo[1];
                } else if(line.startsWith('http')) {
                    ch.url = line;
                    allChannels.push({...ch});
                    ch = { name: 'Unknown', logo: '', url: '' };
                }
            }
            renderList(allChannels);
        }

        function renderList(list) {
            const container = document.getElementById('ch-list');
            document.getElementById('count').innerText = `${list.length} CH`;
            container.innerHTML = '';
            
            // عرض أول 500 قناة فقط (للتسريع)
            list.slice(0, 500).forEach(ch => {
                const div = document.createElement('div');
                div.className = 'ch-item';
                div.innerHTML = `
                    <img src="${ch.logo}" class="ch-img" onerror="this.src='https://via.placeholder.com/30?text=TV'">
                    <div class="ch-name">${ch.name}</div>
                `;
                div.onclick = () => playChannel(ch.url, div);
                container.appendChild(div);
            });
        }

        // --- المشغل السحري (The Magic Player) ---
        function playChannel(url, el) {
            // تحديث UI
            document.querySelectorAll('.ch-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');

            // --- منطق تجاوز HTTP على Netlify ---
            // إذا كان الرابط http والموقع https، يجب استخدام وسيط بث
            const isMixedContent = location.protocol === 'https:' && url.startsWith('http:');
            
            if(isMixedContent) {
                document.getElementById('proxy-badge').style.display = 'block';
                // نستخدم m3u8proxy (خدمة مجانية مفتوحة المصدر)
                // تحول طلب http إلى https وتمرره
                url = `https://m3u8-proxy-cors-msh.vercel.app/cors?url=${encodeURIComponent(url)}`;
            } else {
                document.getElementById('proxy-badge').style.display = 'none';
            }

            // إصلاح الروابط الخام (التي تنتهي برقم أو ts)
            if(!url.includes('.m3u8') && !url.includes('cors?')) {
                // إذا لم يكن يمر عبر البروكسي ولم يكن m3u8، نضيف الامتداد
                 if (url.endsWith('.ts')) {
                    url = url.replace('.ts', '.m3u8');
                } else {
                    // نفترض أنه xtream raw stream
                    url = url + '.m3u8';
                }
            }

            console.log("Playing Final URL:", url);

            const video = document.getElementById('player');
            
            if (Hls.isSupported()) {
                if(hls) hls.destroy();
                hls = new Hls();
                hls.loadSource(url);
                hls.attachMedia(video);
                hls.on(Hls.Events.MANIFEST_PARSED, () => player.play());
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = url;
                player.play();
            }
        }

        function doSearch() {
            const term = document.getElementById('search').value.toLowerCase();
            const filtered = allChannels.filter(c => c.name.toLowerCase().includes(term));
            renderList(filtered);
        }
    </script>
</body>
</html>
