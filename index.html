 <!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Ultimate Player V4</title>
    <link href="https://vjs.zencdn.net/8.3.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.3.0/video.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { --primary: #00d2ff; --bg: #050505; --card: #121212; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background: var(--bg); color: white; height: 100vh; overflow: hidden; }
        
        /* تصميم شريط التمرير (Scrollbar) */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 10px; }

        /* شاشة الدخول */
        .login-overlay { position: fixed; inset: 0; background: #000; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-box { background: var(--card); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; border: 1px solid #222; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #333; background: #000; color: white; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; background: var(--primary); color: #000; font-weight: bold; cursor: pointer; }

        /* الواجهة الرئيسية */
        .main-app { display: none; display: flex; height: 100vh; width: 100vw; }
        
        /* القائمة الجانبية مع تمرير حر */
        .sidebar { width: 350px; background: var(--card); display: flex; flex-direction: column; border-left: 1px solid #222; }
        .search-box { padding: 15px; background: #1a1a1a; }
        .channel-container { flex-grow: 1; overflow-y: auto; padding: 10px; height: calc(100vh - 100px); }
        
        .channel-item { 
            display: flex; align-items: center; padding: 12px; margin-bottom: 8px; 
            background: #1a1a1a; border-radius: 10px; cursor: pointer; transition: 0.3s;
        }
        .channel-item:hover { background: var(--primary); color: #000; }
        .channel-item img { width: 40px; height: 40px; border-radius: 5px; margin-left: 12px; object-fit: contain; background: #000; }

        /* منطقة المشغل */
        .player-area { flex-grow: 1; display: flex; flex-direction: column; background: #000; position: relative; }
        .video-js { width: 100% !important; height: 100% !important; }

        /* زر المفضلة */
        .fav-btn { margin-right: auto; cursor: pointer; color: #555; }
        .fav-btn.active { color: #ffd700; }

        @media (max-width: 768px) {
            .main-app { flex-direction: column-reverse; }
            .sidebar { width: 100%; height: 50%; }
        }
    </style>
</head>
<body>

    <div id="loginScreen" class="login-overlay">
        <div class="login-box">
            <h2 style="text-align: center;">Gemini <span style="color:var(--primary)">IPTV</span></h2>
            <input type="text" id="host" placeholder="السيرفر (مثال: http://site.com:8080)">
            <input type="text" id="user" placeholder="اسم المستخدم">
            <input type="password" id="pass" placeholder="كلمة المرور">
            <button class="btn" onclick="startXtream()">دخول</button>
            <p style="text-align: center; font-size: 12px; color: #555;">أو ارفع ملف M3U</p>
            <input type="file" id="m3uFile" accept=".m3u" onchange="startM3U()">
            <div id="loading" style="display:none; text-align:center; margin-top:10px;">جاري التحميل...</div>
        </div>
    </div>

    <div id="app" class="main-app" style="display: none;">
        <div class="sidebar">
            <div class="search-box">
                <input type="text" id="search" placeholder="بحث عن قناة..." oninput="searchChannels()">
            </div>
            <div id="channelContainer" class="channel-container">
                </div>
        </div>
        <div class="player-area">
            <video id="my-video" class="video-js vjs-big-play-centered" controls preload="auto" data-setup='{}'>
                <p class="vjs-no-js">للأسف متصفحك لا يدعم تشغيل الفيديو</p>
            </video>
        </div>
    </div>

    <script>
        let allChannels = [];
        let player = videojs('my-video');

        // تشغيل Xtream مع تجاوز CORS
        async function startXtream() {
            const host = document.getElementById('host').value;
            const user = document.getElementById('user').value;
            const pass = document.getElementById('pass').value;
            if(!host || !user || !pass) return alert("أكمل البيانات");

            document.getElementById('loading').style.display = 'block';
            const apiUrl = `${host}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(apiUrl)}`;

            try {
                const res = await fetch(proxyUrl);
                const dataRaw = await res.json();
                const data = JSON.parse(dataRaw.contents);
                
                allChannels = data.map(ch => ({
                    name: ch.name,
                    icon: ch.stream_icon,
                    url: `${host}/live/${user}/${pass}/${ch.stream_id}.ts`
                }));
                showApp();
            } catch (e) {
                alert("خطأ في البيانات أو السيرفر");
                document.getElementById('loading').style.display = 'none';
            }
        }

        // تشغيل ملف M3U محلي
        function startM3U() {
            const file = document.getElementById('m3uFile').files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const lines = e.target.result.split('\n');
                allChannels = [];
                for(let i=0; i<lines.length; i++) {
                    if(lines[i].includes('#EXTINF')) {
                        const name = lines[i].split(',')[1];
                        const url = lines[i+1].trim();
                        allChannels.push({ name, url, icon: '' });
                    }
                }
                showApp();
            };
            reader.readAsText(file);
        }

        function showApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'flex';
            renderChannels(allChannels);
        }

        function renderChannels(list) {
            const container = document.getElementById('channelContainer');
            container.innerHTML = '';
            list.forEach((ch, index) => {
                const div = document.createElement('div');
                div.className = 'channel-item';
                div.innerHTML = `
                    <img src="${ch.icon || 'https://via.placeholder.com/40'}" onerror="this.src='https://cdn-icons-png.flaticon.com/512/716/716429.png'">
                    <span>${ch.name}</span>
                `;
                div.onclick = () => playChannel(ch.url);
                container.appendChild(div);
            });
        }

        function playChannel(url) {
            // المشغل يدعم الآن التحويل التلقائي بين m3u8 و ts و mp4
            player.src({
                src: url,
                type: url.includes('m3u8') ? 'application/x-mpegURL' : 'video/mp4' 
            });
            player.play();
        }

        function searchChannels() {
            const term = document.getElementById('search').value.toLowerCase();
            const filtered = allChannels.filter(c => c.name.toLowerCase().includes(term));
            renderChannels(filtered);
        }
    </script>
</body>
</html>
