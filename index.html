<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer"> <!-- مهم جداً لتجاوز حظر السيرفرات -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Xtream Player Pro - Unlocked V10</title>
    
    <!-- مكتبات التشغيل الأقوى عالمياً -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mpegts.js@1.7.3/dist/mpegts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/artplayer/dist/artplayer.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- تصميم "الوضع الليلي الحقيقي" --- */
        :root {
            --bg: #000000;
            --panel: #0f0f0f;
            --border: 1px solid #222;
            --accent: #e50914; /* أحمر قوي */
            --text: #fff;
            --active: rgba(255, 255, 255, 0.1);
        }

        * { box-sizing: border-box; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; }

        /* القائمة الجانبية */
        .sidebar {
            width: 320px; background: var(--panel); border-left: var(--border); display: flex; flex-direction: column;
            transition: transform 0.3s; z-index: 100; box-shadow: 5px 0 15px rgba(0,0,0,0.5);
        }
        
        .header {
            padding: 15px; background: #050505; border-bottom: var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .logo { font-weight: bold; font-size: 16px; color: var(--accent); letter-spacing: 1px; display: flex; align-items: center; gap: 8px; }
        
        /* أدوات التحكم */
        .controls-area { padding: 10px; background: #080808; border-bottom: var(--border); }
        .input-group { position: relative; width: 100%; margin-bottom: 8px; }
        .main-input {
            width: 100%; background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 10px 30px 10px 10px;
            border-radius: 4px; font-family: 'Tajawal'; font-size: 12px;
        }
        .main-input:focus { border-color: var(--accent); }
        .load-btn {
            width: 100%; background: var(--accent); color: white; border: none; padding: 8px;
            border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s;
        }
        .load-btn:hover { background: #b0060e; }
        
        .tab-buttons { display: flex; gap: 5px; margin-bottom: 8px; }
        .tab-btn { flex: 1; background: #1a1a1a; border: 1px solid #333; color: #888; padding: 6px; font-size: 10px; cursor: pointer; border-radius: 4px; }
        .tab-btn.active { background: #333; color: #fff; border-color: #555; }

        /* قائمة القنوات */
        .channel-list { flex: 1; overflow-y: auto; padding: 5px; }
        .channel-item {
            display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #1a1a1a;
            cursor: pointer; transition: 0.2s; border-radius: 4px;
        }
        .channel-item:hover { background: var(--active); }
        .channel-item.active { background: #1a1a1a; border-right: 3px solid var(--accent); }
        .ch-num { font-size: 10px; color: #555; min-width: 20px; }
        .ch-name { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
        .ch-logo { width: 30px; height: 30px; background: #000; border-radius: 4px; object-fit: contain; }

        /* منطقة الفيديو */
        .player-container { flex: 1; background: #000; position: relative; display: flex; align-items: center; justify-content: center; }
        .artplayer-app { width: 100%; height: 100%; }
        
        /* شاشة الترحيب */
        .empty-state {
            position: absolute; text-align: center; color: #333; pointer-events: none;
        }
        .empty-state i { font-size: 80px; margin-bottom: 20px; opacity: 0.5; }

        /* رسائل النظام */
        .status-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.9); padding: 8px 20px; border-radius: 30px;
            font-size: 12px; display: none; z-index: 99; border: 1px solid #444;
        }
        .spinner { display: inline-block; width: 10px; height: 10px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 5px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* التجاوب */
        @media (max-width: 768px) {
            body { flex-direction: column-reverse; }
            .sidebar { width: 100%; height: 50%; }
            .player-container { height: 50%; }
        }

        /* سكرول بار */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }
    </style>
</head>
<body>

    <!-- القائمة الجانبية -->
    <div class="sidebar">
        <div class="header">
            <div class="logo"><i class="fas fa-infinity"></i> XTREAM V10</div>
            <div style="font-size:10px; color:#555;" id="count">0 Channels</div>
        </div>

        <div class="controls-area">
            <!-- التبويبات -->
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="setMode('url')">رابط M3U</button>
                <button class="tab-btn" onclick="setMode('xtream')">Xtream</button>
                <button class="tab-btn" onclick="setMode('file')">ملف</button>
            </div>

            <!-- نموذج الرابط (الافتراضي) -->
            <div id="form-url">
                <input type="text" id="m3u-url" class="main-input" placeholder="ألصق رابط القائمة الطويل هنا...">
                <button class="load-btn" onclick="loadUrl()">جلب القنوات</button>
            </div>

            <!-- نموذج Xtream -->
            <div id="form-xtream" style="display:none;">
                <input type="text" id="x-host" class="main-input" style="margin-bottom:5px;" placeholder="Host">
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input type="text" id="x-user" class="main-input" placeholder="User">
                    <input type="text" id="x-pass" class="main-input" placeholder="Pass">
                </div>
                <button class="load-btn" onclick="loadXtream()">اتصال</button>
            </div>

            <!-- نموذج الملف -->
            <div id="form-file" style="display:none;">
                <button class="load-btn" style="background:#333;" onclick="document.getElementById('local-file').click()">
                    <i class="fas fa-folder"></i> اختر ملف M3U
                </button>
                <input type="file" id="local-file" accept=".m3u,.m3u8" style="display:none;" onchange="loadFile()">
            </div>

            <!-- البحث -->
            <input type="text" id="search" class="main-input" style="margin-top:10px;" placeholder="بحث سريع..." onkeyup="doSearch()">
        </div>

        <div class="channel-list" id="list">
            <div style="text-align:center; padding:20px; color:#444; font-size:12px;">
                القائمة فارغة.<br>قم بلصق رابط واضغط جلب.
            </div>
        </div>
    </div>

    <!-- المشغل -->
    <div class="player-container">
        <div class="empty-state" id="emptyState">
            <i class="fas fa-play-circle"></i>
            <h3>Ready to Play</h3>
        </div>
        <div id="artplayer" class="artplayer-app"></div>
        <div id="status" class="status-bar"></div>
    </div>

    <script>
        // --- تهيئة المتغيرات ---
        let art = null;
        let allChannels = [];
        let currentMode = 'url';

        // استعادة آخر رابط تم استخدامه
        window.onload = () => {
            const savedUrl = localStorage.getItem('last_m3u_url');
            if(savedUrl) document.getElementById('m3u-url').value = savedUrl;
        };

        // --- وظائف الواجهة ---
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('form-url').style.display = 'none';
            document.getElementById('form-xtream').style.display = 'none';
            document.getElementById('form-file').style.display = 'none';
            
            document.getElementById('form-' + mode).style.display = 'block';
        }

        function showStatus(msg, loading = false) {
            const el = document.getElementById('status');
            el.innerHTML = msg + (loading ? ' <span class="spinner"></span>' : '');
            el.style.display = 'block';
            if (!loading) setTimeout(() => el.style.display = 'none', 3000);
        }

        // --- 1. تحميل رابط M3U (الأهم) ---
        async function loadUrl() {
            const url = document.getElementById('m3u-url').value.trim();
            if (!url) return showStatus('الرجاء إدخال الرابط');

            showStatus('جاري تحميل القائمة...', true);
            
            // استخدام وكيل (Proxy) لتخطي مشاكل CORS عند جلب النص فقط
            // ملاحظة: الفيديو نفسه سيعمل مباشرة لأننا نستخدم No-Referrer
            const proxy = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            
            try {
                const response = await fetch(proxy);
                if (!response.ok) throw new Error('فشل التحميل');
                const text = await response.text();
                
                parseAndRender(text);
                localStorage.setItem('last_m3u_url', url);
                showStatus(`تم تحميل ${allChannels.length} قناة`);

            } catch (err) {
                console.error(err);
                showStatus('فشل جلب القائمة. تأكد من صحة الرابط');
            }
        }

        // --- 2. تحميل Xtream ---
        async function loadXtream() {
            let host = document.getElementById('x-host').value.trim();
            const user = document.getElementById('x-user').value.trim();
            const pass = document.getElementById('x-pass').value.trim();
            
            if(!host || !user || !pass) return showStatus('بيانات ناقصة');
            if(!host.startsWith('http')) host = 'http://' + host;

            showStatus('جاري الاتصال...', true);
            const api = `${host}/player_api.php?username=${user}&password=${pass}&action=get_live_streams`;
            const proxy = `https://corsproxy.io/?${encodeURIComponent(api)}`;

            try {
                const res = await fetch(proxy);
                const data = await res.json();
                
                // تحويل بيانات Xtream إلى صيغة M3U للتوافق
                allChannels = data.map(ch => ({
                    name: ch.name,
                    logo: ch.stream_icon,
                    // سر المهنة: إضافة m3u8 للرابط ليجبره على العمل
                    url: `${host}/live/${user}/${pass}/${ch.stream_id}.m3u8`
                }));

                renderList(allChannels);
                showStatus(`تم جلب ${allChannels.length} قناة`);

            } catch (e) {
                showStatus('فشل الاتصال بـ Xtream');
            }
        }

        // --- 3. تحميل ملف ---
        function loadFile() {
            const file = document.getElementById('local-file').files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => parseAndRender(e.target.result);
            reader.readAsText(file);
        }

        // --- تحليل البيانات (Parsing Logic) ---
        function parseAndRender(data) {
            const lines = data.split('\n');
            allChannels = [];
            let currentCh = { name: 'قناة غير معروفة', logo: '', url: '' };

            for (let line of lines) {
                line = line.trim();
                if (!line) continue;

                if (line.startsWith('#EXTINF:')) {
                    const info = line.split(',');
                    currentCh.name = info[info.length - 1];
                    const logoMatch = line.match(/tvg-logo="([^"]*)"/);
                    if (logoMatch) currentCh.logo = logoMatch[1];
                } else if (line.startsWith('http')) {
                    currentCh.url = line;
                    allChannels.push({ ...currentCh });
                    currentCh = { name: 'قناة غير معروفة', logo: '', url: '' };
                }
            }
            renderList(allChannels);
        }

        function renderList(channels) {
            const container = document.getElementById('list');
            document.getElementById('count').innerText = `${channels.length} Channels`;
            container.innerHTML = '';

            // عرض أول 500 قناة فقط للأداء
            const limit = channels.slice(0, 500);

            limit.forEach(ch => {
                const div = document.createElement('div');
                div.className = 'channel-item';
                div.innerHTML = `
                    <span class="ch-num"><i class="fas fa-tv"></i></span>
                    <span class="ch-name">${ch.name}</span>
                `;
                div.onclick = () => playChannel(ch.url, div);
                container.appendChild(div);
            });
        }

        // --- وظيفة البحث السريع ---
        function doSearch() {
            const term = document.getElementById('search').value.toLowerCase();
            const filtered = allChannels.filter(c => c.name.toLowerCase().includes(term));
            renderList(filtered);
        }

        // --- المشغل (ArtPlayer + Engines) ---
        function playChannel(url, el) {
            // تحديث الواجهة
            document.querySelectorAll('.channel-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
            document.getElementById('emptyState').style.display = 'none';

            // تنظيف المشغل القديم
            if (art) art.destroy();

            // تحديد المحرك المناسب
            let type = 'm3u8';
            // إذا الرابط ينتهي بـ .ts أو يحتوي على mpegts أو هو رابط xtream خام (رقم فقط)
            if (url.includes('mpegts') || url.endsWith('.ts') || url.match(/\/\d+$/)) {
                type = 'mpegts'; 
            }

            console.log(`Playing: ${url} [Type: ${type}]`);

            art = new Artplayer({
                container: '#artplayer',
                url: url,
                type: type,
                volume: 0.8,
                isLive: true,
                autoplay: true,
                pip: true,
                fullscreen: true,
                autoSize: true,
                setting: true,
                // إعدادات مخصصة للمحركات
                customType: {
                    m3u8: function (video, url) {
                        if (Hls.isSupported()) {
                            const hls = new Hls();
                            hls.loadSource(url);
                            hls.attachMedia(video);
                        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                            video.src = url;
                        }
                    },
                    mpegts: function (video, url) {
                        if (mpegts.isSupported()) {
                            const player = mpegts.createPlayer({
                                type: 'mpegts',
                                url: url,
                                isLive: true,
                                cors: true 
                            });
                            player.attachMediaElement(video);
                            player.load();
                            player.play();
                        } else {
                            showStatus('المتصفح لا يدعم MPEGTS');
                        }
                    }
                }
            });
            
            // تدوير تلقائي للموبايل
            art.on('play', () => {
                if(window.innerWidth < 768) art.fullscreen = true;
            });
            
            art.on('error', () => {
                showStatus('خطأ في البث: تأكد من الرابط أو بروتوكول HTTP');
            });
        }
    </script>
</body>
</html>
